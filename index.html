<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    <title>War Room - CRM Log√≠stica</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS para ler XLSX -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .animate-slide-down { animation: slideDown 0.2s ease-out; }
        .animate-slide-right { animation: slideRight 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ============================================================
        // √çCONES SVG
        // ============================================================
        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                phone: <path strokeLinecap="round" strokeLinejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />,
                phoneOutgoing: <><path strokeLinecap="round" strokeLinejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /><path strokeLinecap="round" strokeLinejoin="round" d="M16 3h5m0 0v5m0-5l-6 6" /></>,
                mail: <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />,
                mapPin: <><path strokeLinecap="round" strokeLinejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></>,
                search: <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />,
                x: <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />,
                check: <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />,
                checkCircle: <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />,
                checkSquare: <><path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4" /><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" fill="none" /></>,
                plus: <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />,
                filter: <path strokeLinecap="round" strokeLinejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />,
                calendar: <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />,
                star: <path strokeLinecap="round" strokeLinejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />,
                starFilled: <path fill="currentColor" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />,
                chevronLeft: <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />,
                chevronRight: <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />,
                chevronDown: <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />,
                upload: <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />,
                user: <path strokeLinecap="round" strokeLinejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />,
                briefcase: <path strokeLinecap="round" strokeLinejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />,
                clock: <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />,
                ban: <path strokeLinecap="round" strokeLinejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />,
                sliders: <path strokeLinecap="round" strokeLinejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />,
                refresh: <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />,
                bell: <path strokeLinecap="round" strokeLinejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />,
                alert: <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />,
                snowflake: <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v18m0-18l-3 3m3-3l3 3m-3 15l-3-3m3 3l3-3M3 12h18M3 12l3-3m-3 3l3 3m15-3l-3-3m3 3l-3 3" />,
                archive: <path strokeLinecap="round" strokeLinejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />,
                truck: <path strokeLinecap="round" strokeLinejoin="round" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0zM13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1" />,
            };
            return (
                <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    {icons[name]}
                </svg>
            );
        };

        // ============================================================
        // DADOS E CONFIGURA√á√ïES
        // ============================================================
        const INITIAL_LEADS = [
            { id: 1, company: "Expresso Rio Vermelho", locations: [{ address: "Nova Mutum - MT", notes: "Sede principal" }], type: "Transporte rodovi√°rio (Cargas)", phones: ["(65) 3308-3939"], emails: [], responsible: "", calledPhones: [] },
            { id: 2, company: "Cooperativa BRCOOP", locations: [{ address: "Nova Mutum - MT", notes: "" }], type: "Transporte rodovi√°rio", phones: ["(65) 3308-3784"], emails: [], responsible: "", calledPhones: [] },
            { id: 3, company: "Transpatto", locations: [{ address: "Nova Mutum - MT", notes: "" }, { address: "Sorriso - MT", notes: "Filial - dif√≠cil acesso na √©poca de chuva" }], type: "Transporte rodovi√°rio", phones: ["(65) 3308-4458", "(65) 9 9988-8858"], emails: [], responsible: "", calledPhones: [] },
            { id: 4, company: "1500 Transportes", locations: [{ address: "Nova Mutum - MT", notes: "" }, { address: "Lucas do Rio Verde - MT", notes: "Fazenda S√£o Jos√© - entrada pelo km 42" }], type: "Gr√£os e Carga Geral", phones: ["(65) 3308-3247"], emails: ["novamutum.mt@1500transportes.com.br"], responsible: "", calledPhones: [] },
        ];

        const PREDEFINED_TAGS = [
            { id: 'no_answer', label: 'Sem Resposta', color: 'bg-indigo-50 text-indigo-700 border-indigo-200', btnColor: 'text-indigo-600 border-indigo-200 hover:bg-indigo-50' },
            { id: 'gatekeeper', label: 'Gatekeeper', color: 'bg-rose-50 text-rose-700 border-rose-200', btnColor: 'text-rose-600 border-rose-200 hover:bg-rose-50' },
            { id: 'referral_check', label: 'Buscando Decisor', color: 'bg-blue-50 text-blue-700 border-blue-200', btnColor: 'text-blue-600 border-blue-200 hover:bg-blue-50' },
            { id: 'nurture', label: 'Nurture', color: 'bg-amber-50 text-amber-700 border-amber-200', btnColor: 'text-amber-600 border-amber-200 hover:bg-amber-50' },
            { id: 'scheduled', label: 'Agendado', color: 'bg-emerald-50 text-emerald-700 border-emerald-200', btnColor: 'text-emerald-600 border-emerald-200 hover:bg-emerald-50' },
        ];

        const LOGISTICS_CONFIG = {
            grade: { label: 'Grade', icon: 'üìê', options: ['Ambos', 'Grade Alta', 'Grade Baixa'], colors: { 'Ambos': 'bg-slate-100 text-slate-600', 'Grade Alta': 'bg-blue-100 text-blue-700', 'Grade Baixa': 'bg-cyan-100 text-cyan-700' } },
            traction: { label: 'Tra√ß√£o', icon: 'üöõ', options: ['Ambos', 'Tra√ßado', 'N√£o Tra√ßado'], colors: { 'Ambos': 'bg-slate-100 text-slate-600', 'Tra√ßado': 'bg-orange-100 text-orange-700', 'N√£o Tra√ßado': 'bg-yellow-100 text-yellow-700' } },
            cargo: { label: 'Carga', icon: 'üì¶', options: ['Ambos', 'Cimento', 'BigBag', 'Cavaco', 'Madeira', 'Gr√£os', 'Outros'], colors: { 'Ambos': 'bg-slate-100 text-slate-600', 'Cimento': 'bg-stone-100 text-stone-700', 'BigBag': 'bg-purple-100 text-purple-700', 'Cavaco': 'bg-amber-100 text-amber-700', 'Madeira': 'bg-orange-100 text-orange-800', 'Gr√£os': 'bg-emerald-100 text-emerald-700', 'Outros': 'bg-pink-100 text-pink-700' } },
            axle: { label: 'Eixos', icon: '‚öôÔ∏è', options: ['Ambos', '7 Eixos', '9 Eixos'], colors: { 'Ambos': 'bg-slate-100 text-slate-600', '7 Eixos': 'bg-indigo-100 text-indigo-700', '9 Eixos': 'bg-violet-100 text-violet-700' } }
        };

        const EMPTY_FILTERS = { tags: [], difficulty: null, potential: null, minRating: 0, grade: null, traction: null, cargo: null, axle: null, cooldownDays: null, showDisqualified: false, cities: [] };

        // ============================================================
        // COMPONENTES
        // ============================================================
        function LogisticsDropdown({ type, value, customValue, onChange, onCustomChange }) {
            const [isOpen, setIsOpen] = useState(false);
            const config = LOGISTICS_CONFIG[type];
            const displayValue = value === 'Outros' && customValue ? customValue : value;
            const colorClass = config.colors[value] || 'bg-slate-100 text-slate-600';
            return (
                <div className="relative" style={{ zIndex: isOpen ? 100 : 1 }}>
                    <button onClick={() => setIsOpen(!isOpen)} className={`w-full flex items-center justify-between gap-2 px-3 py-2.5 rounded-xl border-2 border-transparent transition-all hover:border-slate-300 ${colorClass}`}>
                        <div className="flex items-center gap-2"><span className="text-base">{config.icon}</span><div className="text-left"><div className="text-[10px] uppercase tracking-wider opacity-60 font-semibold">{config.label}</div><div className="text-sm font-bold -mt-0.5">{displayValue}</div></div></div>
                        <Icon name="chevronDown" size={14} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                    </button>
                    {isOpen && (<div className="absolute top-full left-0 right-0 mt-1 bg-white rounded-xl shadow-xl border z-[100] animate-slide-down" style={{ maxHeight: '300px', overflowY: 'auto' }}><div className="p-1">{config.options.map((option) => (<button key={option} onClick={() => { onChange(option); setIsOpen(false); }} className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium flex items-center justify-between ${value === option ? config.colors[option] : 'hover:bg-slate-50'}`}>{option} {value === option && <Icon name="check" size={14} />}</button>))}</div></div>)}
                    {value === 'Outros' && (<input type="text" placeholder="Especifique..." value={customValue || ''} onChange={(e) => onCustomChange(e.target.value)} className="mt-2 w-full px-3 py-2 text-sm border-2 border-pink-200 rounded-lg focus:outline-none focus:border-pink-400 bg-pink-50" autoFocus />)}
                </div>
            );
        }

        function LogisticsBox({ logistics, customCargo, onUpdate, onCustomCargoChange }) {
            return (
                <div className="bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl p-4 border border-slate-200" style={{ overflow: 'visible' }}>
                    <div className="flex items-center gap-2 mb-3 pb-2 border-b border-slate-200"><Icon name="truck" size={16} className="text-slate-500" /><span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Especifica√ß√µes do Ve√≠culo</span></div>
                    <div className="grid grid-cols-2 gap-2" style={{ overflow: 'visible' }}>
                        <LogisticsDropdown type="grade" value={logistics.grade || 'Ambos'} onChange={(v) => onUpdate({ ...logistics, grade: v })} />
                        <LogisticsDropdown type="traction" value={logistics.traction || 'Ambos'} onChange={(v) => onUpdate({ ...logistics, traction: v })} />
                        <LogisticsDropdown type="cargo" value={logistics.cargo || 'Ambos'} customValue={customCargo} onChange={(v) => onUpdate({ ...logistics, cargo: v })} onCustomChange={onCustomCargoChange} />
                        <LogisticsDropdown type="axle" value={logistics.axle || 'Ambos'} onChange={(v) => onUpdate({ ...logistics, axle: v })} />
                    </div>
                </div>
            );
        }

        // Modal de Localiza√ß√µes
        function LocationModal({ isOpen, onClose, locations, onUpdate, companyName }) {
            const [newAddress, setNewAddress] = useState('');
            const [newNotes, setNewNotes] = useState('');
            const [editingIndex, setEditingIndex] = useState(null);
            const [editAddress, setEditAddress] = useState('');
            const [editNotes, setEditNotes] = useState('');

            if (!isOpen) return null;

            const handleAdd = () => {
                if (!newAddress.trim()) return;
                onUpdate([...locations, { address: newAddress.trim(), notes: newNotes.trim() }]);
                setNewAddress(''); setNewNotes('');
            };

            const handleEdit = (index) => {
                setEditingIndex(index);
                setEditAddress(locations[index].address);
                setEditNotes(locations[index].notes || '');
            };

            const handleSaveEdit = () => {
                if (!editAddress.trim()) return;
                const updated = [...locations];
                updated[editingIndex] = { address: editAddress.trim(), notes: editNotes.trim() };
                onUpdate(updated);
                setEditingIndex(null);
            };

            const handleDelete = (index) => {
                if (locations.length === 1) return alert('√â necess√°rio ter pelo menos uma localiza√ß√£o.');
                onUpdate(locations.filter((_, i) => i !== index));
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="bg-gradient-to-r from-teal-600 to-cyan-600 p-4 text-white">
                            <div className="flex justify-between items-center">
                                <h3 className="font-bold flex items-center gap-2"><Icon name="mapPin" size={20} /> Localiza√ß√µes</h3>
                                <button onClick={onClose} className="p-1 hover:bg-white/20 rounded-lg"><Icon name="x" size={20} /></button>
                            </div>
                            <p className="text-sm text-white/80 mt-1">{companyName}</p>
                        </div>
                        
                        <div className="p-4 max-h-[50vh] overflow-y-auto">
                            {locations.map((loc, index) => (
                                <div key={index} className="mb-3 p-3 bg-slate-50 rounded-xl border border-slate-200">
                                    {editingIndex === index ? (
                                        <div className="space-y-2">
                                            <input type="text" value={editAddress} onChange={e => setEditAddress(e.target.value)} placeholder="Endere√ßo..." className="w-full px-3 py-2 text-sm border-2 rounded-lg focus:outline-none focus:border-teal-400" />
                                            <textarea value={editNotes} onChange={e => setEditNotes(e.target.value)} placeholder="Observa√ß√µes (fazenda, dif√≠cil acesso...)" className="w-full px-3 py-2 text-sm border-2 rounded-lg focus:outline-none focus:border-teal-400 resize-none" rows={2} />
                                            <div className="flex gap-2">
                                                <button onClick={handleSaveEdit} className="flex-1 py-2 text-sm font-bold bg-teal-600 text-white rounded-lg hover:bg-teal-700">Salvar</button>
                                                <button onClick={() => setEditingIndex(null)} className="px-4 py-2 text-sm font-bold border rounded-lg hover:bg-slate-100">Cancelar</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <div className="flex items-start justify-between gap-2">
                                                <div className="flex items-center gap-2">
                                                    <div className="p-1.5 bg-teal-100 rounded-lg text-teal-600"><Icon name="mapPin" size={14} /></div>
                                                    <span className="font-bold text-slate-800">{loc.address}</span>
                                                </div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => handleEdit(index)} className="p-1.5 text-slate-400 hover:text-teal-600 hover:bg-teal-50 rounded" title="Editar">‚úèÔ∏è</button>
                                                    {locations.length > 1 && <button onClick={() => handleDelete(index)} className="p-1.5 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded" title="Remover">üóëÔ∏è</button>}
                                                </div>
                                            </div>
                                            {loc.notes && <p className="mt-2 text-xs text-slate-500 bg-white px-3 py-2 rounded-lg border border-dashed border-slate-200">üí¨ {loc.notes}</p>}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        <div className="p-4 bg-slate-50 border-t">
                            <div className="text-xs font-bold text-slate-400 uppercase mb-2">+ Adicionar Localiza√ß√£o</div>
                            <div className="space-y-2">
                                <input type="text" value={newAddress} onChange={e => setNewAddress(e.target.value)} placeholder="Cidade / Endere√ßo..." className="w-full px-3 py-2 text-sm border-2 rounded-lg focus:outline-none focus:border-teal-400" />
                                <textarea value={newNotes} onChange={e => setNewNotes(e.target.value)} placeholder="Observa√ß√µes (fazenda, dif√≠cil acesso, refer√™ncias...)" className="w-full px-3 py-2 text-sm border-2 rounded-lg focus:outline-none focus:border-teal-400 resize-none" rows={2} />
                                <button onClick={handleAdd} disabled={!newAddress.trim()} className="w-full py-2.5 text-sm font-bold bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                    <Icon name="plus" size={16} /> Adicionar Localiza√ß√£o
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Bot√£o de telefone com checklist de liga√ß√£o
        function PhoneButton({ phone, called, onToggleCalled, onCopy }) {
            const [copied, setCopied] = useState(false);
            const handleCopy = (e) => {
                e.stopPropagation();
                navigator.clipboard?.writeText(phone).catch(() => { const ta = document.createElement("textarea"); ta.value = phone; ta.style.position = "fixed"; ta.style.left = "-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); });
                setCopied(true); setTimeout(() => setCopied(false), 1500);
            };
            return (
                <div className={`group flex items-center gap-2 w-full p-2.5 rounded-lg border transition-all ${called ? 'bg-emerald-50 border-emerald-300' : 'bg-white border-slate-200 hover:border-indigo-300'}`}>
                    <button onClick={handleCopy} className={`flex-1 flex items-center gap-3 text-left ${copied ? 'text-emerald-700' : 'text-slate-600'}`}>
                        <div className={`p-1.5 rounded-md ${copied ? 'bg-emerald-100' : called ? 'bg-emerald-100' : 'bg-slate-100 group-hover:bg-indigo-50'}`}>
                            {copied ? <Icon name="check" size={14} className="text-emerald-600" /> : <Icon name="phone" size={14} className={called ? 'text-emerald-600' : ''} />}
                        </div>
                        <div className="flex-1 min-w-0">
                            <div className="text-xs text-slate-400 font-medium uppercase">Telefone</div>
                            <div className="text-sm font-mono truncate font-semibold">{phone}</div>
                        </div>
                    </button>
                    <button onClick={(e) => { e.stopPropagation(); onToggleCalled(); }} 
                        className={`p-2 rounded-lg border-2 transition-all ${called ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white border-slate-200 text-slate-300 hover:border-emerald-400 hover:text-emerald-500'}`}
                        title={called ? 'Liga√ß√£o feita' : 'Marcar como ligado'}>
                        <Icon name="check" size={16} />
                    </button>
                </div>
            );
        }

        function CopyButton({ text, type }) {
            const [copied, setCopied] = useState(false);
            const handleCopy = (e) => {
                e.stopPropagation();
                navigator.clipboard?.writeText(text).catch(() => { const ta = document.createElement("textarea"); ta.value = text; ta.style.position = "fixed"; ta.style.left = "-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); });
                setCopied(true); setTimeout(() => setCopied(false), 1500);
            };
            return (
                <button onClick={handleCopy} className={`group flex items-center gap-3 w-full p-2.5 rounded-lg border transition-all ${copied ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white border-slate-200 text-slate-600 hover:border-indigo-300'}`}>
                    <div className={`p-1.5 rounded-md ${copied ? 'bg-emerald-100' : 'bg-slate-100 group-hover:bg-indigo-50'}`}>{copied ? <Icon name="check" size={14} /> : <Icon name={type} size={14} />}</div>
                    <div className="flex-1 min-w-0 text-left"><div className="text-xs text-slate-400 font-medium uppercase">{type === 'phone' ? 'Telefone' : 'E-mail'}</div><div className="text-sm font-mono truncate font-semibold">{text}</div></div>
                </button>
            );
        }

        function ScheduleModal({ isOpen, onClose, onConfirm }) {
            const [step, setStep] = useState('date');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [selectedHour, setSelectedHour] = useState(null);
            useEffect(() => { if (isOpen) { setStep('date'); setSelectedDate(new Date()); setSelectedHour(null); } }, [isOpen]);
            if (!isOpen) return null;
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="bg-slate-50 border-b p-4 flex justify-between items-center"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="calendar" size={20} className="text-emerald-500" /> Agendar</h3><button onClick={onClose}><Icon name="x" size={20} /></button></div>
                        <div className="p-4">
                            {step === 'date' && (<div className="animate-slide-in"><div className="flex justify-between items-center mb-4"><button onClick={() => setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth() - 1, 1))} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="chevronLeft" /></button><span className="font-bold">{monthNames[selectedDate.getMonth()]} {selectedDate.getFullYear()}</span><button onClick={() => setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 1))} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="chevronRight" /></button></div><div className="grid grid-cols-7 gap-1 text-center mb-2">{['D','S','T','Q','Q','S','S'].map((d,i) => <div key={i} className="text-xs font-bold text-slate-400">{d}</div>)}</div><div className="grid grid-cols-7 gap-1">{(() => { const days = [], y = selectedDate.getFullYear(), m = selectedDate.getMonth(); for (let i = 0; i < new Date(y,m,1).getDay(); i++) days.push(<div key={`e${i}`} />); for (let i = 1; i <= new Date(y,m+1,0).getDate(); i++) { const isToday = new Date().toDateString() === new Date(y,m,i).toDateString(); days.push(<button key={i} onClick={() => { setSelectedDate(new Date(y,m,i)); setStep('hour'); }} className={`aspect-square rounded-lg text-sm font-medium hover:scale-110 transition-transform ${isToday ? 'bg-indigo-50 text-indigo-600 border border-indigo-200' : 'hover:bg-slate-100'}`}>{i}</button>); } return days; })()}</div></div>)}
                            {step === 'hour' && (<div className="animate-slide-in"><button onClick={() => setStep('date')} className="flex items-center gap-1 text-sm text-slate-500 hover:text-indigo-600 mb-4"><Icon name="chevronLeft" size={14} /> Voltar</button><div className="grid grid-cols-4 gap-2 max-h-[200px] overflow-y-auto">{[8,9,10,11,12,13,14,15,16,17,18,19].map(h => (<button key={h} onClick={() => { setSelectedHour(h); setStep('minute'); }} className="py-2 rounded-lg border border-slate-200 hover:bg-emerald-50 hover:border-emerald-200 font-mono text-sm">{h}:00</button>))}</div></div>)}
                            {step === 'minute' && (<div className="animate-slide-in"><button onClick={() => setStep('hour')} className="flex items-center gap-1 text-sm text-slate-500 hover:text-indigo-600 mb-4"><Icon name="chevronLeft" size={14} /> Voltar</button><div className="grid grid-cols-2 gap-2">{[0,15,30,45].map(m => (<button key={m} onClick={() => { const d = selectedDate.getDate().toString().padStart(2,'0'); const mo = (selectedDate.getMonth()+1).toString().padStart(2,'0'); onConfirm(`Agendado: ${d}/${mo} √†s ${selectedHour}:${m.toString().padStart(2,'0')}`); }} className="py-3 rounded-lg border border-slate-200 hover:bg-emerald-500 hover:text-white font-mono">{selectedHour}:{m.toString().padStart(2,'0')}</button>))}</div></div>)}
                        </div>
                    </div>
                </div>
            );
        }

        // Fun√ß√£o para parsear arquivo (CSV ou XLSX)
        function parseFileToLeads(data, isXLSX, listName) {
            let rows = [];
            if (isXLSX) {
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
            } else {
                const text = new TextDecoder('UTF-8').decode(data);
                rows = text.split('\n').filter(l => l.trim()).map(line => line.split(/[,;]/).map(v => v.trim().replace(/"/g, '')));
            }
            
            if (rows.length < 2) return [];
            
            const headers = rows[0].map(h => String(h).toLowerCase().trim());
            const leads = [];
            
            const findCol = (names) => {
                for (const n of names) {
                    const idx = headers.findIndex(h => h.includes(n));
                    if (idx !== -1) return idx;
                }
                return -1;
            };
            
            // Mapeamento flex√≠vel de colunas
            const colMap = {
                company: findCol(['empresa', 'company', 'nome', 'raz√£o', 'razao']),
                city: findCol(['cidade', 'city', 'munic√≠pio', 'municipio', 'localiza√ß√£o', 'localizacao']),
                state: findCol(['estado', 'uf', 'state']),
                phone: findCol(['telefone', 'phone', 'fone', 'celular', 'whatsapp']),
                email: findCol(['email', 'e-mail', 'mail']),
                responsible: findCol(['respons√°vel', 'responsavel', 'contato', 'contact', 'decisor']),
                type: findCol(['tipo', 'type', 'segmento', 'ramo', 'atividade']),
                cnpj: findCol(['cnpj', 'documento']),
                address: findCol(['endere√ßo', 'endereco', 'address', 'rua', 'logradouro']),
            };
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const get = (col) => col >= 0 && row[col] ? String(row[col]).trim() : '';
                
                const company = get(colMap.company) || get(0);
                if (!company) continue;
                
                const city = get(colMap.city);
                const state = get(colMap.state);
                const locationStr = state ? `${city} - ${state}` : city;
                
                // Coleta todos os telefones da linha
                const phones = [];
                if (colMap.phone >= 0) {
                    const phoneStr = get(colMap.phone);
                    phoneStr.split(/[;|,]/).forEach(p => {
                        const clean = p.trim();
                        if (clean && clean.length >= 8) phones.push(clean);
                    });
                }
                // Procura colunas adicionais de telefone
                headers.forEach((h, idx) => {
                    if ((h.includes('telefone') || h.includes('phone') || h.includes('celular') || h.includes('whatsapp')) && idx !== colMap.phone) {
                        const val = get(idx);
                        if (val && val.length >= 8 && !phones.includes(val)) phones.push(val);
                    }
                });
                
                // Coleta emails
                const emails = [];
                if (colMap.email >= 0) {
                    get(colMap.email).split(/[;|,]/).forEach(e => {
                        const clean = e.trim();
                        if (clean && clean.includes('@')) emails.push(clean);
                    });
                }
                
                const lead = {
                    id: Date.now() + i + Math.random(),
                    company,
                    locations: locationStr ? [{ address: locationStr, notes: get(colMap.address) }] : [{ address: 'N√£o informado', notes: '' }],
                    type: get(colMap.type),
                    phones: phones.length ? phones : [],
                    emails,
                    responsible: get(colMap.responsible),
                    cnpj: get(colMap.cnpj),
                    notes: '',
                    activeTasks: [],
                    qualifiers: { difficulty: null, potential: null, rating: 0 },
                    logistics: { grade: 'Ambos', traction: 'Ambos', cargo: 'Ambos', axle: 'Ambos' },
                    customCargo: '',
                    calledPhones: [],
                    listName: listName || 'Principal'
                };
                leads.push(lead);
            }
            return leads;
        }

        function ImportModal({ isOpen, onClose, onImport, lists, onCreateList }) {
            const [loading, setLoading] = useState(false);
            const [preview, setPreview] = useState(null);
            const [listName, setListName] = useState('');
            const [createNew, setCreateNew] = useState(true);
            const [selectedList, setSelectedList] = useState('');
            
            useEffect(() => { if (isOpen) { setPreview(null); setListName(''); setCreateNew(true); } }, [isOpen]);
            
            if (!isOpen) return null;
            
            const handleFile = async (file) => {
                setLoading(true);
                try {
                    const isXLSX = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
                    const buffer = await file.arrayBuffer();
                    const leads = parseFileToLeads(new Uint8Array(buffer), isXLSX, '');
                    
                    if (leads.length === 0) {
                        alert('Nenhum lead encontrado no arquivo');
                        setLoading(false);
                        return;
                    }
                    
                    // Sugere nome da lista baseado no arquivo
                    const suggestedName = file.name.replace(/\.(xlsx|xls|csv|txt)$/i, '').replace(/_/g, ' ');
                    setListName(suggestedName);
                    setPreview({ leads, fileName: file.name, columns: Object.keys(leads[0]).filter(k => leads[0][k]) });
                } catch (err) {
                    console.error(err);
                    alert('Erro ao ler arquivo: ' + err.message);
                }
                setLoading(false);
            };
            
            const handleConfirm = () => {
                if (!preview) return;
                const finalListName = createNew ? (listName.trim() || 'Lista Importada') : selectedList;
                const leadsWithList = preview.leads.map(l => ({ ...l, listName: finalListName }));
                
                if (createNew && finalListName) {
                    onCreateList(finalListName);
                }
                onImport(leadsWithList);
                onClose();
            };
            
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 text-white">
                            <div className="flex justify-between items-center">
                                <h2 className="text-lg font-bold flex items-center gap-2">
                                    <Icon name="upload" size={20} /> Importar Leads
                                </h2>
                                <button onClick={onClose} className="p-1 hover:bg-white/20 rounded-lg"><Icon name="x" size={20} /></button>
                            </div>
                            <p className="text-sm text-white/80 mt-1">Suporta arquivos CSV e Excel (.xlsx)</p>
                        </div>
                        
                        <div className="p-4">
                            {!preview ? (
                                <label 
                                    htmlFor="file-upload-input"
                                    className={`block border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-all ${loading ? 'border-indigo-400 bg-indigo-50' : 'border-slate-300 hover:border-indigo-400 hover:bg-indigo-50/50'}`}
                                    onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.add('border-indigo-400', 'bg-indigo-50'); }}
                                    onDragLeave={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('border-indigo-400', 'bg-indigo-50'); }}
                                    onDrop={(e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('border-indigo-400', 'bg-indigo-50'); const file = e.dataTransfer.files[0]; if (file) handleFile(file); }}
                                >
                                    {loading ? (
                                        <div className="animate-pulse"><div className="w-12 h-12 bg-indigo-200 rounded-full mx-auto mb-3"></div><p className="text-indigo-600 font-medium">Processando arquivo...</p></div>
                                    ) : (
                                        <><Icon name="upload" size={40} className="mx-auto text-slate-400 mb-3" /><p className="text-slate-600 font-medium mb-1">Clique ou arraste arquivo aqui</p><p className="text-xs text-slate-400">.xlsx, .xls, .csv</p></>
                                    )}
                                    <input id="file-upload-input" type="file" accept=".csv,.txt,.xlsx,.xls" className="hidden" onChange={(e) => { if (e.target.files[0]) handleFile(e.target.files[0]); e.target.value = ''; }} />
                                </label>
                            ) : (
                                <div className="animate-slide-in">
                                    <div className="flex items-center gap-3 p-3 bg-emerald-50 rounded-xl border border-emerald-200 mb-4">
                                        <div className="p-2 bg-emerald-100 rounded-lg"><Icon name="check" size={20} className="text-emerald-600" /></div>
                                        <div><p className="font-bold text-emerald-800">{preview.leads.length} leads encontrados</p><p className="text-xs text-emerald-600">{preview.fileName}</p></div>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Destino da Importa√ß√£o</label>
                                        <div className="flex gap-2 mb-3">
                                            <button onClick={() => setCreateNew(true)} className={`flex-1 py-2 text-sm font-bold rounded-lg border-2 transition-all ${createNew ? 'bg-indigo-50 border-indigo-400 text-indigo-700' : 'border-slate-200 text-slate-500'}`}>+ Nova Lista</button>
                                            <button onClick={() => setCreateNew(false)} disabled={lists.length === 0} className={`flex-1 py-2 text-sm font-bold rounded-lg border-2 transition-all ${!createNew ? 'bg-indigo-50 border-indigo-400 text-indigo-700' : 'border-slate-200 text-slate-500'} disabled:opacity-50`}>Lista Existente</button>
                                        </div>
                                        
                                        {createNew ? (
                                            <input type="text" value={listName} onChange={e => setListName(e.target.value)} placeholder="Nome da nova lista..." className="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:border-indigo-400" />
                                        ) : (
                                            <select value={selectedList} onChange={e => setSelectedList(e.target.value)} className="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:border-indigo-400">
                                                <option value="">Selecione uma lista...</option>
                                                {lists.map(l => <option key={l} value={l}>{l}</option>)}
                                            </select>
                                        )}
                                    </div>
                                    
                                    <div className="bg-slate-50 rounded-xl p-3 mb-4 max-h-32 overflow-y-auto">
                                        <p className="text-xs font-bold text-slate-400 uppercase mb-2">Pr√©via dos dados</p>
                                        {preview.leads.slice(0, 3).map((l, i) => (
                                            <div key={i} className="text-xs py-1 border-b border-slate-200 last:border-0">
                                                <span className="font-bold text-slate-700">{l.company}</span>
                                                <span className="text-slate-400 ml-2">{l.locations?.[0]?.address}</span>
                                            </div>
                                        ))}
                                        {preview.leads.length > 3 && <p className="text-xs text-slate-400 mt-2">...e mais {preview.leads.length - 3} leads</p>}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="p-4 bg-slate-50 border-t flex gap-3">
                            <button onClick={() => setPreview(null)} className="flex-1 py-3 text-sm font-bold rounded-xl border-2 border-slate-200 text-slate-500 hover:bg-white">{preview ? 'Voltar' : 'Cancelar'}</button>
                            <button onClick={handleConfirm} disabled={!preview || (createNew && !listName.trim()) || (!createNew && !selectedList)} className="flex-1 py-3 text-sm font-bold rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">Importar {preview?.leads.length || 0} Leads</button>
                        </div>
                    </div>
                </div>
            );
        }

        function MeetingsModal({ isOpen, onClose, meetings }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="bg-indigo-600 p-4 flex justify-between items-center text-white"><h3 className="font-bold flex items-center gap-2"><Icon name="calendar" size={20} /> Agenda do Dia</h3><button onClick={onClose}><Icon name="x" size={20} /></button></div>
                        <div className="p-4 max-h-[60vh] overflow-y-auto">
                            {meetings.length === 0 ? (<div className="text-center py-10 text-slate-400"><Icon name="calendar" size={48} className="mx-auto mb-3 opacity-30" /><p>Nenhuma reuni√£o para hoje</p></div>) :
                                meetings.map(m => (<div key={m.id} className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border mb-2"><div className="bg-white px-2 py-1 rounded-lg border font-mono text-indigo-600 font-bold text-sm">{m.meetingTime}</div><div className="flex-1 min-w-0"><div className="font-bold text-slate-800 truncate">{m.company}</div><div className="text-xs text-slate-500">{m.responsible || 'Sem respons√°vel'}</div></div><a href={`tel:${m.phones[0]?.replace(/\D/g,'')}`} className="p-2 text-slate-400 hover:text-emerald-600"><Icon name="phone" size={16} /></a></div>))}
                        </div>
                    </div>
                </div>
            );
        }

        function AdvancedFiltersPanel({ isOpen, onClose, filters, setFilters, leadsCount, availableCities }) {
            const [citySearch, setCitySearch] = useState('');
            if (!isOpen) return null;
            const toggleArrayFilter = (key, value) => { setFilters(prev => ({ ...prev, [key]: prev[key].includes(value) ? prev[key].filter(v => v !== value) : [...prev[key], value] })); };
            const toggleFilter = (key, value) => { setFilters(prev => ({ ...prev, [key]: prev[key] === value ? null : value })); };
            const clearAll = () => { setFilters(EMPTY_FILTERS); setCitySearch(''); };
            const activeCount = filters.tags.length + (filters.difficulty ? 1 : 0) + (filters.potential ? 1 : 0) + (filters.minRating ? 1 : 0) + (filters.grade ? 1 : 0) + (filters.traction ? 1 : 0) + (filters.cargo ? 1 : 0) + (filters.axle ? 1 : 0) + (filters.cooldownDays ? 1 : 0) + (filters.showDisqualified ? 1 : 0) + filters.cities.length;
            const FilterSection = ({ title, children }) => (<div className="mb-6"><h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2"><div className="w-1 h-4 bg-indigo-500 rounded"></div>{title}</h4>{children}</div>);
            return (
                <div className="fixed inset-0 z-50 animate-fade-in">
                    <div className="absolute inset-0 bg-black/30" onClick={onClose} />
                    <div className="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl animate-slide-right overflow-hidden flex flex-col">
                        <div className="bg-gradient-to-r from-indigo-600 to-violet-600 p-5 text-white">
                            <div className="flex justify-between items-center mb-3"><h3 className="font-bold text-lg flex items-center gap-2"><Icon name="filter" size={20} /> Filtros Avan√ßados</h3><button onClick={onClose} className="p-1 hover:bg-white/20 rounded-lg"><Icon name="x" size={20} /></button></div>
                            <div className="flex items-center justify-between bg-white/10 rounded-lg px-3 py-2"><span className="text-sm">{leadsCount} leads encontrados</span>{activeCount > 0 && (<button onClick={clearAll} className="text-xs bg-white/20 px-2 py-1 rounded hover:bg-white/30">{activeCount} filtros ativos ‚Ä¢ Limpar</button>)}</div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-5">
                            <FilterSection title="Status / Tags"><div className="flex flex-wrap gap-2">{PREDEFINED_TAGS.map(tag => (<button key={tag.id} onClick={() => toggleArrayFilter('tags', tag.id)} className={`px-3 py-1.5 text-xs font-bold rounded-lg border-2 transition-all ${filters.tags.includes(tag.id) ? tag.color + ' border-current' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}>{filters.tags.includes(tag.id) && <span className="mr-1">‚úì</span>}{tag.label}</button>))}<button onClick={() => setFilters(prev => ({ ...prev, showDisqualified: !prev.showDisqualified }))} className={`px-3 py-1.5 text-xs font-bold rounded-lg border-2 transition-all flex items-center gap-1 ${filters.showDisqualified ? 'bg-slate-200 border-slate-400 text-slate-700' : 'bg-white border-slate-200 text-slate-400 hover:border-slate-300'}`}><Icon name="archive" size={12} /> Desqualificados</button></div></FilterSection>
                            <FilterSection title="Cooldown (dias sem resposta)"><div className="flex flex-wrap gap-2">{[{v: 3, l: '3+ dias'}, {v: 5, l: '5+ dias'}, {v: 7, l: '7+ dias'}, {v: 14, l: '14+ dias'}].map(opt => (<button key={opt.v} onClick={() => toggleFilter('cooldownDays', opt.v)} className={`px-3 py-1.5 text-xs font-bold rounded-lg border-2 transition-all ${filters.cooldownDays === opt.v ? 'bg-indigo-100 border-indigo-400 text-indigo-700' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}>{filters.cooldownDays === opt.v && '‚úì '}{opt.l}</button>))}</div></FilterSection>
                            <FilterSection title="Dificuldade de Acesso"><div className="flex gap-2">{[{v: 'easy', l: 'üü¢ Livre', c: 'emerald'}, {v: 'medium', l: 'üü° GK', c: 'amber'}, {v: 'hard', l: 'üî¥ Hard', c: 'rose'}].map(d => (<button key={d.v} onClick={() => toggleFilter('difficulty', d.v)} className={`flex-1 px-3 py-2 text-sm font-bold rounded-xl border-2 transition-all ${filters.difficulty === d.v ? `bg-${d.c}-100 border-${d.c}-400 text-${d.c}-700` : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}>{d.l}</button>))}</div></FilterSection>
                            <FilterSection title="Potencial de Valor"><div className="flex gap-2">{[{v: 'low', l: '$ Baixo'}, {v: 'medium', l: '$$ M√©dio'}, {v: 'high', l: '$$$ Alto'}].map(p => (<button key={p.v} onClick={() => toggleFilter('potential', p.v)} className={`flex-1 px-3 py-2 text-sm font-bold rounded-xl border-2 transition-all ${filters.potential === p.v ? 'bg-emerald-100 border-emerald-400 text-emerald-700' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}>{p.l}</button>))}</div></FilterSection>
                            <FilterSection title="Avalia√ß√£o M√≠nima"><div className="flex items-center gap-3 bg-slate-50 rounded-xl p-3 border"><span className="text-sm text-slate-600">M√≠nimo:</span><div className="flex gap-1">{[1,2,3,4,5].map(s => (<button key={s} onClick={() => setFilters(prev => ({ ...prev, minRating: prev.minRating === s ? 0 : s }))} className={`p-1 transition-transform hover:scale-110 ${filters.minRating >= s ? 'text-yellow-400' : 'text-slate-300'}`}><Icon name={filters.minRating >= s ? 'starFilled' : 'star'} size={24} /></button>))}</div>{filters.minRating > 0 && <span className="text-xs text-slate-400 ml-auto">{filters.minRating}+ estrelas</span>}</div></FilterSection>
                            <FilterSection title="Cidades / Localiza√ß√µes">
                                {availableCities.length === 0 ? (<p className="text-sm text-slate-400 italic">Nenhuma cidade cadastrada</p>) : (
                                    <div className="space-y-2">
                                        <div className="relative">
                                            <Icon name="search" size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-300" />
                                            <input 
                                                type="text" 
                                                placeholder="Buscar cidade..." 
                                                value={citySearch}
                                                onChange={(e) => setCitySearch(e.target.value)}
                                                className="w-full pl-9 pr-3 py-2 text-sm border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-teal-500/30 focus:border-teal-400"
                                            />
                                            {citySearch && (
                                                <button onClick={() => setCitySearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-500">
                                                    <Icon name="x" size={14} />
                                                </button>
                                            )}
                                        </div>
                                        <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-1">
                                            {availableCities.filter(c => c.toLowerCase().includes(citySearch.toLowerCase())).map(city => (
                                                <button key={city} onClick={() => toggleArrayFilter('cities', city)}
                                                    className={`px-3 py-1.5 text-xs font-bold rounded-lg border-2 transition-all flex items-center gap-1 ${filters.cities.includes(city) ? 'bg-teal-100 border-teal-400 text-teal-700' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}>
                                                    {filters.cities.includes(city) && '‚úì '}<Icon name="mapPin" size={12} /> {city}
                                                </button>
                                            ))}
                                            {availableCities.filter(c => c.toLowerCase().includes(citySearch.toLowerCase())).length === 0 && (
                                                <p className="text-xs text-slate-400 italic py-2">Nenhuma cidade encontrada</p>
                                            )}
                                        </div>
                                        {filters.cities.length > 0 && (
                                            <div className="text-xs text-teal-600 font-medium">{filters.cities.length} cidade(s) selecionada(s)</div>
                                        )}
                                    </div>
                                )}
                            </FilterSection>
                            <FilterSection title="Especifica√ß√µes do Ve√≠culo"><div className="grid grid-cols-2 gap-3">{Object.entries(LOGISTICS_CONFIG).map(([key, config]) => (<div key={key}><div className="text-[10px] font-bold text-slate-400 uppercase mb-1.5">{config.icon} {config.label}</div><select value={filters[key] || ''} onChange={(e) => setFilters(prev => ({ ...prev, [key]: e.target.value || null }))} className={`w-full px-3 py-2 text-sm border-2 rounded-lg focus:outline-none ${filters[key] ? 'border-indigo-400 bg-indigo-50' : 'border-slate-200 bg-white'}`}><option value="">Qualquer</option>{config.options.filter(o => o !== 'Ambos').map(opt => (<option key={opt} value={opt}>{opt}</option>))}</select></div>))}</div></FilterSection>
                        </div>
                        <div className="p-4 bg-slate-50 border-t flex gap-3"><button onClick={clearAll} className="flex-1 py-3 text-sm font-bold rounded-xl border-2 border-slate-200 text-slate-500 hover:bg-white">Limpar Tudo</button><button onClick={onClose} className="flex-1 py-3 text-sm font-bold rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Ver {leadsCount} Resultados</button></div>
                    </div>
                </div>
            );
        }

        // ============================================================
        // APP PRINCIPAL
        // ============================================================
        // Sidebar de gerenciamento de listas
        function ListsSidebar({ isOpen, onToggle, lists, activeList, onSelectList, onCreateList, onDeleteList, onRenameList, leadsCount }) {
            const [newListName, setNewListName] = useState('');
            const [editingList, setEditingList] = useState(null);
            const [editName, setEditName] = useState('');
            
            const handleCreate = () => {
                if (newListName.trim()) {
                    onCreateList(newListName.trim());
                    setNewListName('');
                }
            };
            
            const handleRename = () => {
                if (editName.trim() && editingList) {
                    onRenameList(editingList, editName.trim());
                    setEditingList(null);
                }
            };
            
            return (
                <>
                    {/* Toggle button para mobile */}
                    <button onClick={onToggle} className={`fixed top-20 left-0 z-30 p-2 bg-white border rounded-r-xl shadow-lg transition-all ${isOpen ? 'translate-x-60' : 'translate-x-0'}`}>
                        <Icon name={isOpen ? 'chevronLeft' : 'chevronRight'} size={16} />
                    </button>
                    
                    {/* Sidebar */}
                    <div className={`fixed left-0 top-0 h-full w-64 bg-slate-900 text-white z-40 transition-transform duration-300 ${isOpen ? 'translate-x-0' : '-translate-x-full'} flex flex-col shadow-2xl`}>
                        <div className="p-4 border-b border-slate-700">
                            <div className="flex items-center gap-2 mb-1">
                                <div className="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center"><Icon name="briefcase" size={16} /></div>
                                <span className="font-bold text-lg">Listas</span>
                            </div>
                            <p className="text-xs text-slate-400">Gerenciador de leads</p>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-2">
                            <button onClick={() => onSelectList(null)} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left mb-1 transition-all ${activeList === null ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-800'}`}>
                                <Icon name="briefcase" size={16} />
                                <span className="flex-1 font-medium">Todos os Leads</span>
                                <span className="text-xs opacity-60">{leadsCount.total}</span>
                            </button>
                            
                            <div className="h-px bg-slate-700 my-3"></div>
                            
                            <p className="text-[10px] font-bold text-slate-500 uppercase tracking-wider px-3 mb-2">Suas Listas</p>
                            
                            {lists.map(list => (
                                <div key={list} className={`group flex items-center gap-2 px-3 py-2 rounded-lg mb-1 transition-all cursor-pointer ${activeList === list ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}>
                                    {editingList === list ? (
                                        <div className="flex-1 flex gap-2">
                                            <input type="text" value={editName} onChange={e => setEditName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleRename()} className="flex-1 px-2 py-1 text-sm bg-slate-700 rounded border-0 focus:outline-none" autoFocus />
                                            <button onClick={handleRename} className="text-emerald-400 hover:text-emerald-300"><Icon name="check" size={14} /></button>
                                            <button onClick={() => setEditingList(null)} className="text-slate-400 hover:text-white"><Icon name="x" size={14} /></button>
                                        </div>
                                    ) : (
                                        <>
                                            <button onClick={() => onSelectList(list)} className="flex-1 flex items-center gap-2 text-left">
                                                <div className="w-2 h-2 rounded-full bg-emerald-400"></div>
                                                <span className="font-medium truncate">{list}</span>
                                            </button>
                                            <span className="text-xs opacity-60">{leadsCount[list] || 0}</span>
                                            <div className="hidden group-hover:flex gap-1">
                                                <button onClick={() => { setEditingList(list); setEditName(list); }} className="p-1 text-slate-400 hover:text-white"><Icon name="sliders" size={12} /></button>
                                                <button onClick={() => onDeleteList(list)} className="p-1 text-slate-400 hover:text-rose-400"><Icon name="x" size={12} /></button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))}
                            
                            {lists.length === 0 && (
                                <div className="text-center py-8 text-slate-500">
                                    <Icon name="archive" size={32} className="mx-auto mb-2 opacity-30" />
                                    <p className="text-xs">Nenhuma lista criada</p>
                                </div>
                            )}
                        </div>
                        
                        <div className="p-3 border-t border-slate-700">
                            <div className="flex gap-2">
                                <input type="text" value={newListName} onChange={e => setNewListName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleCreate()} placeholder="Nova lista..." className="flex-1 px-3 py-2 text-sm bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:border-indigo-500" />
                                <button onClick={handleCreate} disabled={!newListName.trim()} className="px-3 py-2 bg-indigo-600 rounded-lg hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"><Icon name="plus" size={16} /></button>
                            </div>
                        </div>
                    </div>
                    
                    {/* Overlay */}
                    {isOpen && <div className="fixed inset-0 bg-black/20 z-30 lg:hidden" onClick={onToggle}></div>}
                </>
            );
        }

        function App() {
            const [leads, setLeads] = useState(() => {
                try {
                    const saved = localStorage.getItem('warRoomLeads');
                    const initial = saved ? JSON.parse(saved) : INITIAL_LEADS;
                    return initial.map(l => ({
                        ...l, activeTasks: l.activeTasks || [], notes: l.notes || '',
                        qualifiers: l.qualifiers || { difficulty: null, potential: null, rating: 0 },
                        logistics: l.logistics || { grade: 'Ambos', traction: 'Ambos', cargo: 'Ambos', axle: 'Ambos' },
                        customCargo: l.customCargo || '',
                        calledPhones: l.calledPhones || [],
                        locations: l.locations || (l.location ? [{ address: l.location, notes: '' }] : [{ address: 'N√£o informado', notes: '' }]),
                        listName: l.listName || 'Principal'
                    }));
                } catch (e) { return INITIAL_LEADS; }
            });
            
            // Sistema de listas
            const [lists, setLists] = useState(() => {
                try {
                    const saved = localStorage.getItem('warRoomLists');
                    return saved ? JSON.parse(saved) : ['Principal'];
                } catch (e) { return ['Principal']; }
            });
            const [activeList, setActiveList] = useState(null);
            const [listsSidebarOpen, setListsSidebarOpen] = useState(false);

            const [searchTerm, setSearchTerm] = useState('');
            const [filters, setFilters] = useState(EMPTY_FILTERS);
            const [filtersSidebarOpen, setFiltersSidebarOpen] = useState(false);
            const [operationMode, setOperationMode] = useState(false);
            const [scheduleModal, setScheduleModal] = useState({ open: false, leadId: null });
            const [importModal, setImportModal] = useState(false);
            const [meetingsModal, setMeetingsModal] = useState(false);
            const [locationModal, setLocationModal] = useState({ open: false, leadId: null });
            const [noAnswerMenu, setNoAnswerMenu] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [showInstructions, setShowInstructions] = useState(() => !localStorage.getItem('warRoomInstructionsSeen'));
            
            // Contagem de leads por lista
            const leadsCountByList = useMemo(() => {
                const counts = { total: leads.length };
                lists.forEach(list => { counts[list] = leads.filter(l => l.listName === list).length; });
                return counts;
            }, [leads, lists]);
            
            // Gerenciamento de listas
            const createList = (name) => {
                if (!lists.includes(name)) {
                    setLists(prev => [...prev, name]);
                }
            };
            const deleteList = (name) => {
                if (confirm(`Excluir lista "${name}"? Os leads ser√£o movidos para "Principal".`)) {
                    setLeads(prev => prev.map(l => l.listName === name ? { ...l, listName: 'Principal' } : l));
                    setLists(prev => prev.filter(l => l !== name));
                    if (activeList === name) setActiveList(null);
                }
            };
            const renameList = (oldName, newName) => {
                if (!lists.includes(newName)) {
                    setLeads(prev => prev.map(l => l.listName === oldName ? { ...l, listName: newName } : l));
                    setLists(prev => prev.map(l => l === oldName ? newName : l));
                    if (activeList === oldName) setActiveList(newName);
                }
            };
            
            useEffect(() => { localStorage.setItem('warRoomLists', JSON.stringify(lists)); }, [lists]);

            // Cidades dispon√≠veis (extra√≠das dos leads)
            const availableCities = useMemo(() => {
                const cities = new Set();
                leads.forEach(l => {
                    (l.locations || []).forEach(loc => {
                        if (loc.address) cities.add(loc.address);
                    });
                });
                return Array.from(cities).sort();
            }, [leads]);

            useEffect(() => { localStorage.setItem('warRoomLeads', JSON.stringify(leads)); }, [leads]);
            useEffect(() => { const t = setInterval(() => setCurrentTime(new Date()), 60000); return () => clearInterval(t); }, []);

            // Contador de liga√ß√µes feitas
            const totalCalls = useMemo(() => leads.reduce((acc, l) => acc + (l.calledPhones?.length || 0), 0), [leads]);

            // Contador de "Vou ligar hoje"
            const callTodayCount = useMemo(() => leads.filter(l => l.callToday).length, [leads]);

            // Reuni√µes de hoje
            const { todaysMeetings, hasUrgent } = useMemo(() => {
                const today = new Date();
                const dateStr = `${today.getDate().toString().padStart(2,'0')}/${(today.getMonth()+1).toString().padStart(2,'0')}`;
                const meetings = leads.filter(l => l.activeTasks.some(t => t.id === 'scheduled' && t.label.includes(dateStr)))
                    .map(l => { const task = l.activeTasks.find(t => t.id === 'scheduled'); return { ...l, meetingTime: task.label.split(' √†s ')[1] || '??:??', completed: task.completed }; })
                    .sort((a,b) => a.meetingTime.localeCompare(b.meetingTime));
                const urgent = meetings.some(m => { if (m.completed) return false; const [h,min] = m.meetingTime.split(':').map(Number); const md = new Date(currentTime); md.setHours(h, min, 0, 0); return (md - currentTime) / 60000 <= 15; });
                return { todaysMeetings: meetings, hasUrgent: urgent };
            }, [leads, currentTime]);

            const stats = useMemo(() => ({ total: leads.length, inProgress: leads.filter(l => l.activeTasks.some(t => !t.completed && t.id !== 'disqualified')).length, scheduled: leads.filter(l => l.activeTasks.some(t => t.id === 'scheduled')).length, rejected: leads.filter(l => l.activeTasks.some(t => t.id === 'disqualified')).length }), [leads]);

            const filteredLeads = useMemo(() => {
                return leads.filter(l => {
                    // Filtro de lista
                    if (activeList && l.listName !== activeList) return false;
                    if (searchTerm && !l.company.toLowerCase().includes(searchTerm.toLowerCase()) && !l.notes?.toLowerCase().includes(searchTerm.toLowerCase())) return false;
                    if (filters.tags.length > 0 && !filters.tags.some(tagId => l.activeTasks.some(t => t.id === tagId))) return false;
                    const isDisq = l.activeTasks.some(t => t.id === 'disqualified');
                    if (!filters.showDisqualified && isDisq) return false;
                    if (filters.showDisqualified && filters.tags.length === 0 && !isDisq) return false;
                    if (filters.cooldownDays) { const noAnswerTask = l.activeTasks.find(t => t.id === 'no_answer' && t.cooldownDate); if (!noAnswerTask) return false; const [day, month] = noAnswerTask.cooldownDate.split('/').map(Number); const cooldownDate = new Date(new Date().getFullYear(), month - 1, day); const today = new Date(); today.setHours(0,0,0,0); const daysDiff = Math.ceil((today - cooldownDate) / (1000 * 60 * 60 * 24)); if (daysDiff < filters.cooldownDays) return false; }
                    if (filters.difficulty && l.qualifiers?.difficulty !== filters.difficulty) return false;
                    if (filters.potential && l.qualifiers?.potential !== filters.potential) return false;
                    if (filters.minRating > 0 && (l.qualifiers?.rating || 0) < filters.minRating) return false;
                    if (filters.grade && l.logistics?.grade !== filters.grade && l.logistics?.grade !== 'Ambos') return false;
                    if (filters.traction && l.logistics?.traction !== filters.traction && l.logistics?.traction !== 'Ambos') return false;
                    if (filters.cargo && l.logistics?.cargo !== filters.cargo && l.logistics?.cargo !== 'Ambos') return false;
                    if (filters.axle && l.logistics?.axle !== filters.axle && l.logistics?.axle !== 'Ambos') return false;
                    // Filtro de cidades
                    if (filters.cities.length > 0) {
                        const leadCities = (l.locations || []).map(loc => loc.address);
                        if (!filters.cities.some(city => leadCities.includes(city))) return false;
                    }
                    // Filtro de opera√ß√£o (s√≥ mostra callToday)
                    if (operationMode && !l.callToday) return false;
                    return true;
                });
            }, [leads, searchTerm, filters, activeList, operationMode]);

            const updateLead = (id, updates) => setLeads(prev => prev.map(l => l.id === id ? { ...l, ...updates } : l));
            const togglePhoneCalled = (leadId, phone) => {
                setLeads(prev => prev.map(l => {
                    if (l.id !== leadId) return l;
                    const calledPhones = l.calledPhones || [];
                    return { ...l, calledPhones: calledPhones.includes(phone) ? calledPhones.filter(p => p !== phone) : [...calledPhones, phone] };
                }));
            };
            const addTag = (leadId, tag) => setLeads(prev => prev.map(l => l.id === leadId ? { ...l, activeTasks: [...l.activeTasks.filter(t => t.id !== tag.id), { ...tag, completed: false }] } : l));
            const removeTag = (leadId, tagId) => setLeads(prev => prev.map(l => l.id === leadId ? { ...l, activeTasks: l.activeTasks.filter(t => t.id !== tagId) } : l));
            const toggleTag = (leadId, tagId) => setLeads(prev => prev.map(l => l.id === leadId ? { ...l, activeTasks: l.activeTasks.map(t => t.id === tagId ? { ...t, completed: !t.completed } : t) } : l));

            const handleTagClick = (leadId, tag) => {
                if (tag.id === 'scheduled') setScheduleModal({ open: true, leadId });
                else if (tag.id === 'no_answer') setNoAnswerMenu(noAnswerMenu === leadId ? null : leadId);
                else addTag(leadId, tag);
            };

            const handleNoAnswer = (leadId, attempt) => {
                const days = { 1: 2, 2: 4, 3: 7 };
                const next = new Date(); next.setDate(next.getDate() + days[attempt]);
                addTag(leadId, { id: 'no_answer', label: `Sem Resposta (${attempt}/3)`, cooldownDate: `${next.getDate().toString().padStart(2,'0')}/${(next.getMonth()+1).toString().padStart(2,'0')}`, color: 'bg-indigo-50 text-indigo-600 border-indigo-200' });
                setNoAnswerMenu(null);
            };

            const handleScheduleConfirm = (label) => { addTag(scheduleModal.leadId, { ...PREDEFINED_TAGS.find(t => t.id === 'scheduled'), label }); setScheduleModal({ open: false, leadId: null }); };
            const toggleDisqualified = (leadId) => setLeads(prev => prev.map(l => { if (l.id !== leadId) return l; const has = l.activeTasks.some(t => t.id === 'disqualified'); return { ...l, activeTasks: has ? l.activeTasks.filter(t => t.id !== 'disqualified') : [...l.activeTasks, { id: 'disqualified', label: 'Desqualificado', color: 'bg-slate-200 text-slate-500', completed: false }] }; }));
            const resetData = () => { if (confirm("Apagar tudo?")) { localStorage.removeItem('warRoomLeads'); localStorage.removeItem('warRoomLists'); window.location.reload(); } };
            
            // Sistema de Backup
            const saveBackup = () => {
                const backup = {
                    version: '4.0',
                    date: new Date().toISOString(),
                    leads: leads,
                    lists: lists
                };
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const dateStr = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
                a.href = url;
                a.download = `backup-warroom-${dateStr}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const loadBackup = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        if (backup.leads && Array.isArray(backup.leads)) {
                            if (confirm(`Restaurar backup de ${new Date(backup.date).toLocaleString('pt-BR')}?\n\nIsso substituir√° todos os dados atuais.`)) {
                                setLeads(backup.leads);
                                if (backup.lists) setLists(backup.lists);
                                alert('Backup restaurado com sucesso!');
                            }
                        } else {
                            alert('Arquivo de backup inv√°lido');
                        }
                    } catch (err) {
                        alert('Erro ao ler arquivo de backup');
                    }
                };
                reader.readAsText(file);
            };
            
            const closeInstructions = () => {
                localStorage.setItem('warRoomInstructionsSeen', 'true');
                setShowInstructions(false);
            };

            const hasMeetings = todaysMeetings.length > 0;
            const activeFiltersCount = filters.tags.length + (filters.difficulty ? 1 : 0) + (filters.potential ? 1 : 0) + (filters.minRating ? 1 : 0) + (filters.grade ? 1 : 0) + (filters.traction ? 1 : 0) + (filters.cargo ? 1 : 0) + (filters.axle ? 1 : 0) + (filters.cooldownDays ? 1 : 0) + (filters.showDisqualified ? 1 : 0) + filters.cities.length;

            return (
                <div className="min-h-screen bg-slate-50">
                    <ScheduleModal isOpen={scheduleModal.open} onClose={() => setScheduleModal({ open: false, leadId: null })} onConfirm={handleScheduleConfirm} />
                    <ImportModal isOpen={importModal} onClose={() => setImportModal(false)} onImport={(newLeads) => setLeads(prev => [...prev, ...newLeads])} lists={lists} onCreateList={createList} />
                    <MeetingsModal isOpen={meetingsModal} onClose={() => setMeetingsModal(false)} meetings={todaysMeetings} />
                    <AdvancedFiltersPanel isOpen={filtersSidebarOpen} onClose={() => setFiltersSidebarOpen(false)} filters={filters} setFilters={setFilters} leadsCount={filteredLeads.length} availableCities={availableCities} />
                    <ListsSidebar isOpen={listsSidebarOpen} onToggle={() => setListsSidebarOpen(!listsSidebarOpen)} lists={lists} activeList={activeList} onSelectList={setActiveList} onCreateList={createList} onDeleteList={deleteList} onRenameList={renameList} leadsCount={leadsCountByList} />
                    
                    {/* Modal de Instru√ß√µes */}
                    {showInstructions && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-in">
                                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white">
                                    <h2 className="text-2xl font-black flex items-center gap-3">
                                        <span className="text-3xl">üéØ</span> War Room - CRM
                                    </h2>
                                    <p className="text-white/80 mt-1">Sistema de prospec√ß√£o de clientes</p>
                                </div>
                                
                                <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                                    <div className="flex gap-3 p-3 bg-indigo-50 rounded-xl">
                                        <span className="text-2xl">üì•</span>
                                        <div>
                                            <h3 className="font-bold text-indigo-900">1. Importar Lista</h3>
                                            <p className="text-sm text-indigo-700">Clique no bot√£o <strong>azul de upload</strong> e selecione sua planilha Excel (.xlsx) ou CSV</p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-3 p-3 bg-emerald-50 rounded-xl">
                                        <span className="text-2xl">üìû</span>
                                        <div>
                                            <h3 className="font-bold text-emerald-900">2. Fazer Liga√ß√µes</h3>
                                            <p className="text-sm text-emerald-700">Clique no telefone para ligar. Use o ‚úì ao lado para marcar como "liga√ß√£o feita"</p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-3 p-3 bg-amber-50 rounded-xl">
                                        <span className="text-2xl">üè∑Ô∏è</span>
                                        <div>
                                            <h3 className="font-bold text-amber-900">3. Marcar Status</h3>
                                            <p className="text-sm text-amber-700">Use os bot√µes de status: <strong>Sem Resposta</strong>, <strong>Gatekeeper</strong>, <strong>Nurture</strong>, <strong>Agendado</strong></p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-3 p-3 bg-purple-50 rounded-xl">
                                        <span className="text-2xl">üíæ</span>
                                        <div>
                                            <h3 className="font-bold text-purple-900">4. Salvar Backup</h3>
                                            <p className="text-sm text-purple-700">Clique no bot√£o <strong>verde</strong> para baixar um backup. Fa√ßa isso <strong>todo dia</strong> antes de fechar!</p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-3 p-3 bg-rose-50 rounded-xl">
                                        <span className="text-2xl">‚ö†Ô∏è</span>
                                        <div>
                                            <h3 className="font-bold text-rose-900">Importante</h3>
                                            <p className="text-sm text-rose-700">Os dados ficam salvos no navegador. Se limpar o cache, use o backup para restaurar!</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="p-4 bg-slate-50 border-t">
                                    <button onClick={closeInstructions} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors">
                                        Entendi, vamos come√ßar! üöÄ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    <LocationModal 
                        isOpen={locationModal.open} 
                        onClose={() => setLocationModal({ open: false, leadId: null })} 
                        locations={leads.find(l => l.id === locationModal.leadId)?.locations || []}
                        onUpdate={(newLocations) => updateLead(locationModal.leadId, { locations: newLocations })}
                        companyName={leads.find(l => l.id === locationModal.leadId)?.company || ''}
                    />

                    {/* Header */}
                    <header className="bg-white/95 backdrop-blur-sm border-b sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 py-3">
                            <div className="flex items-center gap-3">
                                {/* Logo e Menu */}
                                <button onClick={() => setListsSidebarOpen(true)} className="p-1.5 hover:bg-slate-100 rounded-lg -ml-1" title="Listas">
                                    <Icon name="chevronRight" size={18} className="text-slate-400" />
                                </button>
                                <div className="mr-auto">
                                    <h1 className="text-lg font-black text-slate-800 flex items-center gap-2">
                                        <Icon name="briefcase" size={20} className="text-indigo-600" />
                                        WAR ROOM
                                        <span className="text-[9px] bg-indigo-600 text-white px-1.5 py-0.5 rounded-full font-bold">4.0</span>
                                    </h1>
                                    <p className="text-[11px] text-slate-400 flex items-center gap-1">
                                        {activeList ? (<><span className="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> {activeList}</>) : 'Todos os Leads'}
                                    </p>
                                </div>

                                {/* Bot√£o COME√áAR OPERA√á√ÉO */}
                                <button 
                                    onClick={() => setOperationMode(!operationMode)} 
                                    className={`px-4 py-2 rounded-xl font-bold text-sm transition-all flex items-center gap-2 ${
                                        operationMode 
                                            ? 'bg-rose-500 text-white shadow-lg shadow-rose-500/30 hover:bg-rose-600' 
                                            : callTodayCount > 0 
                                                ? 'bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-lg shadow-emerald-500/30 hover:shadow-xl animate-pulse' 
                                                : 'bg-slate-100 text-slate-400 hover:bg-slate-200'
                                    }`}
                                    disabled={!operationMode && callTodayCount === 0}
                                >
                                    {operationMode ? (
                                        <><Icon name="x" size={16} /> PARAR</>
                                    ) : (
                                        <><Icon name="phoneOutgoing" size={16} /> COME√áAR ({callTodayCount})</>
                                    )}
                                </button>

                                {/* Reuni√µes - s√≥ √≠cone */}
                                <button onClick={() => setMeetingsModal(true)} className={`relative p-2 rounded-lg transition-all ${hasUrgent ? 'bg-rose-100 text-rose-600' : hasMeetings ? 'bg-emerald-100 text-emerald-600' : 'text-slate-300 hover:bg-slate-100'}`} title={hasMeetings ? `${todaysMeetings.length} reuni√£o(√µes)` : 'Sem reuni√µes'}>
                                    <Icon name="bell" size={18} />
                                    {(hasMeetings || hasUrgent) && <span className={`absolute -top-0.5 -right-0.5 w-4 h-4 text-[9px] font-bold rounded-full flex items-center justify-center ${hasUrgent ? 'bg-rose-500 text-white animate-pulse' : 'bg-emerald-500 text-white'}`}>{todaysMeetings.length}</span>}
                                </button>

                                {/* Separador */}
                                <div className="w-px h-8 bg-slate-200"></div>

                                {/* Stats compacto */}
                                <div className="flex items-center gap-3 text-center">
                                    <div><div className="text-[9px] text-slate-400 font-semibold uppercase tracking-wide">Total</div><div className="text-base font-black text-slate-700">{stats.total}</div></div>
                                    <div><div className="text-[9px] text-orange-500 font-semibold uppercase tracking-wide">Funil</div><div className="text-base font-black text-orange-500">{stats.inProgress}</div></div>
                                    <div><div className="text-[9px] text-emerald-500 font-semibold uppercase tracking-wide">Agend</div><div className="text-base font-black text-emerald-600">{stats.scheduled}</div></div>
                                    <div><div className="text-[9px] text-slate-400 font-semibold uppercase tracking-wide">Perd</div><div className="text-base font-black text-slate-400">{stats.rejected}</div></div>
                                    <div><div className="text-[9px] text-indigo-500 font-semibold uppercase tracking-wide">Calls</div><div className="text-base font-black text-indigo-600">{totalCalls}</div></div>
                                </div>

                                {/* Separador */}
                                <div className="w-px h-8 bg-slate-200"></div>

                                {/* A√ß√µes - texto elegante */}
                                <div className="flex items-center gap-1">
                                    <button onClick={() => setImportModal(true)} className="px-3 py-1.5 text-[11px] font-semibold text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                                        Importar
                                    </button>
                                    <button onClick={saveBackup} className="px-3 py-1.5 text-[11px] font-semibold text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors">
                                        Salvar
                                    </button>
                                    <label className="px-3 py-1.5 text-[11px] font-semibold text-amber-600 hover:bg-amber-50 rounded-lg transition-colors cursor-pointer">
                                        Restaurar
                                        <input type="file" accept=".json" className="hidden" onChange={(e) => { if (e.target.files[0]) loadBackup(e.target.files[0]); e.target.value = ''; }} />
                                    </label>
                                    <button onClick={() => setShowInstructions(true)} className="p-1.5 text-slate-300 hover:text-slate-500 rounded-lg" title="Ajuda">
                                        <Icon name="alert" size={16} />
                                    </button>
                                    <button onClick={resetData} className="p-1.5 text-slate-300 hover:text-rose-500 rounded-lg" title="Apagar">
                                        <Icon name="x" size={16} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main */}
                    <main className="max-w-7xl mx-auto px-4 py-6">
                        <div className="flex gap-3 mb-6">
                            <div className="relative flex-1">
                                <Icon name="search" size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" />
                                <input type="text" placeholder="Pesquisar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-12 pr-4 py-3.5 border rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20" />
                            </div>
                            <button onClick={() => setFiltersSidebarOpen(true)} className={`relative p-3.5 rounded-xl border transition-all ${activeFiltersCount > 0 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white hover:border-indigo-300'}`}>
                                <Icon name="sliders" size={20} />
                                {activeFiltersCount > 0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-rose-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">{activeFiltersCount}</span>}
                            </button>
                        </div>

                        {/* Chips de filtros ativos */}
                        {activeFiltersCount > 0 && (
                            <div className="flex flex-wrap gap-2 mb-4 p-3 bg-indigo-50/50 rounded-xl border border-indigo-100">
                                <span className="text-xs font-bold text-indigo-600 flex items-center gap-1"><Icon name="filter" size={12} /> Filtros:</span>
                                {filters.tags.map(tagId => { const tag = PREDEFINED_TAGS.find(t => t.id === tagId); return tag ? <span key={tagId} className={`px-2 py-0.5 text-xs font-bold rounded-full ${tag.color}`}>{tag.label}</span> : null; })}
                                {filters.cooldownDays && <span className="px-2 py-0.5 text-xs font-bold rounded-full bg-indigo-100 text-indigo-700">Cooldown {filters.cooldownDays}+ dias</span>}
                                {filters.difficulty && <span className="px-2 py-0.5 text-xs font-bold rounded-full bg-slate-100">Dificuldade: {filters.difficulty}</span>}
                                {filters.potential && <span className="px-2 py-0.5 text-xs font-bold rounded-full bg-emerald-100 text-emerald-700">{filters.potential === 'low' ? '$' : filters.potential === 'medium' ? '$$' : '$$$'}</span>}
                                {filters.minRating > 0 && <span className="px-2 py-0.5 text-xs font-bold rounded-full bg-yellow-100 text-yellow-700">{filters.minRating}+ ‚≠ê</span>}
                                {filters.grade && <span className="px-2 py-0.5 text-xs font-bold rounded-full bg-blue-100 text-blue-700">{filters.grade}</span>}
                                {filters.traction && <span className="px-2 py-0.5 text-xs font-bold rounded-full bg-orange-100 text-orange-700">{filters.traction}</span>}
                                {filters.cargo && <span className="px-2 py-0.5 text-xs font-bold rounded-full bg-purple-100 text-purple-700">{filters.cargo}</span>}
                                {filters.axle && <span className="px-2 py-0.5 text-xs font-bold rounded-full bg-violet-100 text-violet-700">{filters.axle}</span>}
                                {filters.showDisqualified && <span className="px-2 py-0.5 text-xs font-bold rounded-full bg-slate-200 text-slate-600">Desqualificados</span>}
                                {filters.cities.map(city => <span key={city} className="px-2 py-0.5 text-xs font-bold rounded-full bg-teal-100 text-teal-700">üìç {city}</span>)}
                                <button onClick={() => setFilters(EMPTY_FILTERS)} className="px-2 py-0.5 text-xs font-bold rounded-full bg-rose-100 text-rose-600 hover:bg-rose-200">‚úï Limpar</button>
                            </div>
                        )}

                        <div className="space-y-6 pb-20">
                            {filteredLeads.length === 0 ? (
                                <div className="text-center py-20 bg-white rounded-2xl border-2 border-dashed">
                                    <Icon name="filter" size={48} className="mx-auto text-slate-300 mb-4" />
                                    <p className="text-slate-500 mb-2">Nenhum lead encontrado</p>
                                    {activeFiltersCount > 0 && <button onClick={() => setFilters(EMPTY_FILTERS)} className="text-indigo-600 text-sm font-bold hover:underline">Limpar filtros</button>}
                                </div>
                            ) : filteredLeads.map(lead => {
                                const isDisq = lead.activeTasks.some(t => t.id === 'disqualified');
                                const isCool = lead.activeTasks.some(t => t.id === 'no_answer');

                                return (
                                    <div key={lead.id} className={`rounded-2xl border shadow-sm transition-all ${isDisq ? 'bg-slate-100 opacity-70' : isCool ? 'bg-slate-50' : 'bg-white hover:shadow-lg'}`}>
                                        {isCool && <div className="bg-indigo-50 px-4 py-2 text-xs font-bold text-indigo-600 flex items-center gap-2"><Icon name="snowflake" size={14} /> COOLDOWN</div>}
                                        
                                        <div className="flex flex-col lg:flex-row">
                                            {/* Sidebar */}
                                            <div className={`w-full lg:w-[340px] p-5 border-b lg:border-b-0 lg:border-r flex flex-col gap-4 ${isDisq ? 'bg-slate-200/50' : 'bg-slate-50/50'}`} style={{ overflow: 'visible' }}>
                                                <div>
                                                    <div className="flex items-start justify-between gap-2 mb-2">
                                                        <h2 className="text-lg font-bold text-slate-900">{lead.company}</h2>
                                                        {lead.responsible && <div className="bg-white border p-1 rounded" title={lead.responsible}><Icon name="user" size={14} className="text-indigo-600" /></div>}
                                                    </div>
                                                    <button onClick={() => setLocationModal({ open: true, leadId: lead.id })} className="flex items-center gap-1 text-xs text-slate-500 mb-4 hover:text-teal-600 transition-colors group">
                                                        <div className="p-1 bg-teal-100 rounded group-hover:bg-teal-200 transition-colors"><Icon name="mapPin" size={12} className="text-teal-600" /></div>
                                                        <span className="font-medium">{lead.locations?.[0]?.address || 'Sem local'}</span>
                                                        {lead.locations?.length > 1 && <span className="bg-teal-100 text-teal-700 px-1.5 py-0.5 rounded text-[10px] font-bold">+{lead.locations.length - 1}</span>}
                                                    </button>
                                                    
                                                    <LogisticsBox logistics={lead.logistics} customCargo={lead.customCargo} onUpdate={(newLogistics) => updateLead(lead.id, { logistics: newLogistics })} onCustomCargoChange={(val) => updateLead(lead.id, { customCargo: val })} />
                                                </div>
                                                
                                                <div className="h-px bg-slate-200"></div>
                                                
                                                <div>
                                                    <span className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Contatos</span>
                                                    <div className="space-y-2">
                                                        {lead.phones.map((p,i) => (
                                                            <PhoneButton 
                                                                key={`p${i}`} 
                                                                phone={p} 
                                                                called={(lead.calledPhones || []).includes(p)} 
                                                                onToggleCalled={() => togglePhoneCalled(lead.id, p)} 
                                                            />
                                                        ))}
                                                        {lead.emails.map((e,i) => <CopyButton key={`e${i}`} text={e} type="mail" />)}
                                                        {!lead.phones.length && !lead.emails.length && <div className="p-3 text-center border border-dashed rounded-lg text-xs text-slate-400">Sem contato</div>}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Main */}
                                            <div className="flex-1 p-5 flex flex-col min-h-[280px]">
                                                <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
                                                    <div className="flex flex-wrap gap-2">
                                                        <div className="flex bg-slate-100 p-1 rounded-lg">
                                                            {[{v:'easy',l:'Livre',c:'bg-emerald-500 text-white'},{v:'medium',l:'GK',c:'bg-amber-100 text-amber-700'},{v:'hard',l:'Hard',c:'bg-rose-100 text-rose-700'}].map(d => (
                                                                <button key={d.v} onClick={() => updateLead(lead.id, { qualifiers: { ...lead.qualifiers, difficulty: lead.qualifiers?.difficulty === d.v ? null : d.v } })}
                                                                    className={`px-3 py-1 rounded text-xs font-bold ${lead.qualifiers?.difficulty === d.v ? d.c : 'text-slate-400'}`}>{d.l}</button>
                                                            ))}
                                                        </div>
                                                        <div className="flex bg-slate-100 p-1 rounded-lg">
                                                            {[{v:'low',l:'$',c:'bg-slate-200'},{v:'medium',l:'$$',c:'bg-emerald-100 text-emerald-700'},{v:'high',l:'$$$',c:'bg-amber-100 text-amber-700'}].map(p => (
                                                                <button key={p.v} onClick={() => updateLead(lead.id, { qualifiers: { ...lead.qualifiers, potential: lead.qualifiers?.potential === p.v ? null : p.v } })}
                                                                    className={`px-2 py-1 rounded text-xs font-bold ${lead.qualifiers?.potential === p.v ? p.c : 'text-slate-400'}`}>{p.l}</button>
                                                            ))}
                                                        </div>
                                                        <div className="flex bg-slate-100 p-1 rounded-lg gap-0.5">
                                                            {[1,2,3,4,5].map(s => (
                                                                <button key={s} onClick={() => updateLead(lead.id, { qualifiers: { ...lead.qualifiers, rating: lead.qualifiers?.rating === s ? 0 : s } })} className="text-yellow-400 hover:scale-110">
                                                                    <Icon name={lead.qualifiers?.rating >= s ? 'starFilled' : 'star'} size={18} />
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    {/* Checklist Vou Ligar Hoje */}
                                                    <button onClick={() => updateLead(lead.id, { callToday: !lead.callToday })} 
                                                        className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold border-2 transition-all ${lead.callToday ? 'bg-emerald-500 text-white border-emerald-500 shadow-lg shadow-emerald-500/30 scale-105' : 'bg-white text-slate-400 border-slate-200 hover:border-emerald-300 hover:text-emerald-500'}`}>
                                                        <Icon name={lead.callToday ? 'checkCircle' : 'phone'} size={14} />
                                                        {lead.callToday ? '‚úì Ligar Hoje' : 'Ligar Hoje'}
                                                    </button>
                                                    {/* Bot√£o Desqualificar com √≠cone vermelho */}
                                                    <button onClick={() => toggleDisqualified(lead.id)} className={`flex items-center gap-1 px-3 py-1 rounded-lg text-xs font-bold border ${isDisq ? 'bg-slate-600 text-white' : 'bg-white text-slate-400 hover:text-slate-500'}`}>
                                                        <Icon name="ban" size={14} className={isDisq ? '' : 'text-rose-500'} /> {isDisq ? 'Desqualificado' : 'Desqualificar'}
                                                    </button>
                                                </div>

                                                <textarea className={`flex-1 min-h-[100px] text-sm border rounded-xl p-4 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500/20 ${isDisq ? 'bg-slate-100' : 'bg-yellow-50/30'}`}
                                                    placeholder="Anota√ß√µes..." value={lead.notes} onChange={e => updateLead(lead.id, { notes: e.target.value })} disabled={isDisq} />

                                                {lead.activeTasks.filter(t => t.id !== 'disqualified').length > 0 && (
                                                    <div className="flex flex-wrap gap-2 mt-4">
                                                        {lead.activeTasks.filter(t => t.id !== 'disqualified').map(task => (
                                                            <div key={task.id} className={`flex items-center gap-2 pl-2 pr-1 py-1 rounded-lg border text-xs font-bold ${task.completed ? 'bg-slate-50 text-slate-400 line-through' : task.color}`}>
                                                                <button onClick={() => toggleTag(lead.id, task.id)}><Icon name={task.completed ? 'checkSquare' : 'check'} size={14} /></button>
                                                                <span>{task.label}</span>
                                                                {task.cooldownDate && <span className="text-[10px] opacity-70 border-l pl-2">‚Üí {task.cooldownDate}</span>}
                                                                <button onClick={() => removeTag(lead.id, task.id)} className="hover:bg-black/10 rounded p-0.5"><Icon name="x" size={12} /></button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}

                                                {!isDisq && (
                                                    <div className="pt-4 mt-4 border-t">
                                                        <div className="flex flex-wrap gap-2 items-center">
                                                            <span className="text-[10px] font-bold text-slate-400 uppercase mr-2">Status:</span>
                                                            {PREDEFINED_TAGS.map(tag => {
                                                                const active = lead.activeTasks.some(t => t.id === tag.id);
                                                                if (active) return null;
                                                                if (tag.id === 'no_answer') {
                                                                    return (
                                                                        <div key={tag.id} className="relative">
                                                                            <button onClick={e => { e.stopPropagation(); handleTagClick(lead.id, tag); }} className={`px-3 py-1 text-xs font-bold border rounded-lg flex items-center gap-1 ${tag.btnColor} ${noAnswerMenu === lead.id ? 'ring-2 ring-indigo-200' : ''}`}>
                                                                                <Icon name="plus" size={12} /> {tag.label}
                                                                            </button>
                                                                            {noAnswerMenu === lead.id && (
                                                                                <div className="absolute bottom-full left-0 mb-2 w-44 bg-white rounded-xl shadow-xl border z-50 overflow-hidden animate-slide-down">
                                                                                    <div className="p-2 bg-indigo-50 text-[10px] font-bold text-indigo-600 text-center uppercase">Tentativas</div>
                                                                                    {[1,2,3].map(n => (<button key={n} onClick={() => handleNoAnswer(lead.id, n)} className="w-full px-4 py-2 text-xs hover:bg-slate-50 flex justify-between border-t"><span>Tentativa {n}</span><span className={`text-[10px] px-1.5 py-0.5 rounded ${n===1?'bg-emerald-100 text-emerald-700':n===2?'bg-amber-100 text-amber-700':'bg-rose-100 text-rose-700'}`}>+{n===1?2:n===2?4:7}d</span></button>))}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    );
                                                                }
                                                                return (<button key={tag.id} onClick={() => handleTagClick(lead.id, tag)} className={`px-3 py-1 text-xs font-bold border rounded-lg flex items-center gap-1 ${tag.btnColor}`}><Icon name="plus" size={12} /> {tag.label}</button>);
                                                            })}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
